FROM php:8.2-fpm

# Args para el usuario
ARG USER_ID=1000
ARG GROUP_ID=1000

# Instalar dependencias del sistema y PostgreSQL
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    libpng-dev \
    libjpeg62-turbo-dev \
    libfreetype6-dev \
    libonig-dev \
    libxml2-dev \
    libzip-dev \
    libpq-dev \
    zip \
    unzip \
    nano \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
        pdo_pgsql \
        mbstring \
        exif \
        pcntl \
        bcmath \
        gd \
        zip \
        opcache \
    && pecl install redis xdebug \
    && docker-php-ext-enable redis xdebug \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Instalar Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Configuración de PHP para desarrollo
RUN { \
    echo 'display_errors=On'; \
    echo 'display_startup_errors=On'; \
    echo 'error_reporting=E_ALL'; \
    echo 'memory_limit=512M'; \
    echo 'upload_max_filesize=100M'; \
    echo 'post_max_size=100M'; \
    echo 'max_execution_time=600'; \
    } > /usr/local/etc/php/conf.d/development.ini

# Configuración de OPcache para desarrollo
RUN { \
    echo 'opcache.enable=1'; \
    echo 'opcache.revalidate_freq=0'; \
    echo 'opcache.validate_timestamps=1'; \
    echo 'opcache.max_accelerated_files=10000'; \
    echo 'opcache.memory_consumption=256'; \
    } > /usr/local/etc/php/conf.d/opcache.ini

# Configuración de Xdebug
RUN { \
    echo 'xdebug.mode=debug'; \
    echo 'xdebug.client_host=host.docker.internal'; \
    echo 'xdebug.client_port=9003'; \
    echo 'xdebug.idekey=VSCODE'; \
    } > /usr/local/etc/php/conf.d/xdebug.ini

# Crear usuario con el mismo UID/GID que el host
RUN groupadd -g ${GROUP_ID} www \
    && useradd -u ${USER_ID} -g www -m -s /bin/bash www

# Crear directorios necesarios
RUN mkdir -p /var/www \
    && chown -R www:www /var/www

WORKDIR /var/www

USER www

EXPOSE 9000

CMD ["php-fpm"]